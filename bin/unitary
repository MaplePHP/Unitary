#!/usr/bin/env php
<?php
/**
 * MaplePHP Unitary unit testing library
 * @example php unitary --path=fullDirPath --exclude="dir1/dir2/
 */

use MaplePHP\Container\Container;
use MaplePHP\Http\Environment;
use MaplePHP\Http\ResponseFactory;
use MaplePHP\Http\ServerRequest;
use MaplePHP\Http\Uri;
use MaplePHP\Unitary\Kernel\Kernel;

$autoload = __DIR__ . '/../vendor/autoload.php';
if (!file_exists($autoload)) {
    if (!empty($GLOBALS['_composer_autoload_path'])) {
        $autoload = $GLOBALS['_composer_autoload_path'];
    } else {
        fwrite(STDERR, "Autoloader not found. Run `composer install`.\n");
        exit(1);
    }
}

require $autoload;


$env = new Environment();
// Pass argv and expected start directory path where to run tests
$request = new ServerRequest(new Uri($env->getUriParts([
    "argv" => $argv,
    "dir" => (defined("UNITARY_PATH") ? UNITARY_PATH : "./")
])), $env);


$factory = new ResponseFactory();
$kernel = new Kernel($factory);

$kernel->run($request, new \MaplePHP\Emitron\Emitters\CliEmitter());

$kernel->dispatch();
