#!/usr/bin/env php
<?php
/**
 * MaplePHP Unitary bin file
 */

use MaplePHP\Container\Container;
use MaplePHP\Http\Environment;
use MaplePHP\Http\ServerRequest;
use MaplePHP\Http\Uri;
use MaplePHP\Unitary\Kernel\Kernel;
use MaplePHP\Unitary\Kernel\Middlewares\AddCommandMiddleware;

$autoload = __DIR__ . '/../../../../vendor/autoload.php';
$autoload = is_file($autoload) ? $autoload : __DIR__ . '/../vendor/autoload.php';
$autoload = realpath($autoload);

if (!$autoload || !is_file($autoload)) {
    if (!empty($GLOBALS['_composer_autoload_path'])) {
        $autoload = $GLOBALS['_composer_autoload_path'];
    } else {
        fwrite(STDERR, "Autoloader not found. Run `composer install`.\n");
        exit(1);
    }
}

require $autoload;

$env = new Environment();
$request = new ServerRequest(new Uri($env->getUriParts([
    "argv" => $argv,
    "dir" => getcwd()
])), $env);

$kernel = new Kernel(new Container(), [
    AddCommandMiddleware::class,
]);
$kernel->run($request);
